<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>التحكم في سيارة DC عبر البلوتوث</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            -webkit-tap-highlight-color: transparent;
            -webkit-user-select: none;
            user-select: none;
        }

        :root {
            --primary: #1a237e;
            --secondary: #303f9f;
            --danger: #d32f2f;
            --success: #388e3c;
            --warning: #f57c00;
            --light: #f5f5f5;
            --dark: #121212;
            --shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
            --border-radius: 12px;
        }

        body {
            background: linear-gradient(135deg, #0d47a1, #311b92);
            color: white;
            min-height: 100vh;
            padding: 15px;
            overflow-x: hidden;
            touch-action: manipulation;
        }

        .container {
            max-width: 100%;
            margin: 0 auto;
        }

        header {
            text-align: center;
            padding: 20px 0;
            margin-bottom: 20px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        header h1 {
            font-size: 1.8rem;
            margin-bottom: 8px;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        header p {
            font-size: 0.95rem;
            opacity: 0.9;
            color: #bbdefb;
        }

        .status-bar {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: var(--border-radius);
            padding: 18px;
            margin-bottom: 25px;
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            box-shadow: var(--shadow);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .status-item {
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 1rem;
        }

        .status-icon {
            width: 45px;
            height: 45px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.3rem;
            color: white;
            flex-shrink: 0;
        }

        .connected .status-icon {
            background: linear-gradient(135deg, var(--success), #4caf50);
        }

        .disconnected .status-icon {
            background: linear-gradient(135deg, var(--danger), #f44336);
        }

        .fire-detected .status-icon {
            background: linear-gradient(135deg, var(--danger), #f44336);
            animation: pulse 1s infinite;
        }

        .no-fire .status-icon {
            background: linear-gradient(135deg, var(--success), #4caf50);
        }

        .status-text {
            display: flex;
            flex-direction: column;
        }

        .status-label {
            font-size: 0.85rem;
            opacity: 0.8;
            margin-bottom: 3px;
        }

        .status-value {
            font-weight: 600;
            font-size: 1.1rem;
        }

        .control-section {
            display: grid;
            grid-template-columns: 1fr;
            gap: 25px;
            margin-bottom: 25px;
        }

        .control-panel {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: var(--border-radius);
            padding: 20px;
            box-shadow: var(--shadow);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .section-title {
            font-size: 1.3rem;
            margin-bottom: 20px;
            color: white;
            display: flex;
            align-items: center;
            gap: 10px;
            padding-bottom: 10px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.2);
        }

        .section-title i {
            color: #bbdefb;
        }

        .direction-control {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 15px;
            touch-action: none;
        }

        .direction-row {
            display: flex;
            justify-content: center;
            gap: 20px;
            width: 100%;
        }

        .control-btn {
            width: 75px;
            height: 75px;
            border: none;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
            font-size: 1.8rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.15s;
            box-shadow: var(--shadow);
            touch-action: manipulation;
            -webkit-touch-callout: none;
        }

        .control-btn:active {
            transform: scale(0.92);
            background: linear-gradient(135deg, #303f9f, #283593);
        }

        .control-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none !important;
        }

        .center-btn {
            background: linear-gradient(135deg, var(--warning), #ff9800);
        }

        .center-btn:active {
            background: linear-gradient(135deg, #f57c00, #ef6c00);
        }

        .fire-control {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .mode-selector {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
        }

        .mode-btn {
            flex: 1;
            padding: 14px;
            border: 2px solid rgba(255, 255, 255, 0.2);
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            color: white;
            touch-action: manipulation;
        }

        .mode-btn.active {
            background: linear-gradient(135deg, var(--secondary), var(--primary));
            color: white;
            border-color: rgba(255, 255, 255, 0.3);
        }

        .mode-btn:active:not(.active) {
            background: rgba(255, 255, 255, 0.2);
            transform: scale(0.98);
        }

        .manual-controls {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        .fire-btn {
            padding: 16px;
            background: linear-gradient(135deg, var(--danger), #f44336);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 1.1rem;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            touch-action: manipulation;
        }

        .fire-btn:active:not(:disabled) {
            transform: scale(0.95);
            background: linear-gradient(135deg, #c62828, #b71c1c);
        }

        .fire-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none !important;
        }

        .fire-btn.stop {
            background: linear-gradient(135deg, #616161, #424242);
        }

        .fire-btn.stop:active:not(:disabled) {
            background: linear-gradient(135deg, #424242, #212121);
        }

        .auto-status {
            background: rgba(255, 255, 255, 0.08);
            padding: 15px;
            border-radius: 10px;
            text-align: center;
            font-size: 1rem;
            margin-top: 10px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .auto-status.fire-detected {
            background: rgba(211, 47, 47, 0.2);
            color: #ffcdd2;
            font-weight: bold;
            border-color: rgba(211, 47, 47, 0.3);
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.7; }
            100% { opacity: 1; }
        }

        .sensor-data {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-top: 20px;
        }

        .sensor-item {
            background: rgba(255, 255, 255, 0.08);
            padding: 18px;
            border-radius: 10px;
            text-align: center;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .sensor-value {
            font-size: 1.8rem;
            font-weight: bold;
            color: white;
            margin: 8px 0;
            direction: ltr;
        }

        .sensor-label {
            font-size: 0.9rem;
            color: #bbdefb;
        }

        .connection-control {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: var(--border-radius);
            padding: 20px;
            box-shadow: var(--shadow);
            margin-bottom: 25px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .bluetooth-devices {
            margin-top: 15px;
            max-height: 200px;
            overflow-y: auto;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 8px;
            padding: 10px;
        }

        .device-item {
            padding: 12px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            transition: background 0.2s;
        }

        .device-item:active {
            background: rgba(255, 255, 255, 0.1);
        }

        .device-item:last-child {
            border-bottom: none;
        }

        .device-info {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .device-name {
            font-weight: 500;
        }

        .device-id {
            font-size: 0.8rem;
            opacity: 0.7;
            font-family: monospace;
        }

        .connect-btn {
            width: 100%;
            padding: 16px;
            background: linear-gradient(135deg, var(--success), #4caf50);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 1.1rem;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            margin-top: 15px;
            touch-action: manipulation;
        }

        .connect-btn:active:not(:disabled) {
            transform: scale(0.98);
            background: linear-gradient(135deg, #388e3c, #2e7d32);
        }

        .connect-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .connect-btn.disconnect {
            background: linear-gradient(135deg, var(--danger), #f44336);
        }

        .connect-btn.disconnect:active:not(:disabled) {
            background: linear-gradient(135deg, #d32f2f, #c62828);
        }

        .logs {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: var(--border-radius);
            padding: 20px;
            box-shadow: var(--shadow);
            margin-bottom: 20px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .logs-content {
            background: rgba(0, 0, 0, 0.2);
            border-radius: 8px;
            padding: 15px;
            height: 180px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 0.85rem;
            line-height: 1.5;
        }

        .log-entry {
            padding: 6px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
        }

        .log-entry:last-child {
            border-bottom: none;
        }

        .log-time {
            color: #bbdefb;
            font-size: 0.8rem;
            flex-shrink: 0;
            margin-right: 10px;
            direction: ltr;
        }

        .log-text {
            flex-grow: 1;
            word-break: break-word;
        }

        .log-info {
            color: #90caf9;
        }

        .log-success {
            color: #a5d6a7;
        }

        .log-error {
            color: #ef9a9a;
        }

        .log-warning {
            color: #ffcc80;
        }

        footer {
            text-align: center;
            padding-top: 20px;
            color: #bbdefb;
            font-size: 0.85rem;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }

        .instructions {
            background: rgba(255, 255, 255, 0.08);
            border-radius: 10px;
            padding: 18px;
            margin-top: 20px;
            font-size: 0.9rem;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .instructions h3 {
            color: #bbdefb;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 1rem;
        }

        .instructions ul {
            padding-right: 20px;
            margin-bottom: 10px;
        }

        .instructions li {
            margin-bottom: 8px;
            line-height: 1.4;
        }

        /* تحسينات للشاشات الصغيرة */
        @media (max-width: 380px) {
            .control-btn {
                width: 70px;
                height: 70px;
                font-size: 1.6rem;
            }
            
            .status-item {
                font-size: 0.95rem;
            }
            
            .sensor-value {
                font-size: 1.6rem;
            }
        }

        @media (min-width: 768px) {
            body {
                padding: 20px;
                max-width: 500px;
                margin: 0 auto;
            }
        }

        /* تخصيص شريط التمرير */
        ::-webkit-scrollbar {
            width: 6px;
        }

        ::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
        }

        ::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.3);
            border-radius: 10px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: rgba(255, 255, 255, 0.4);
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1><i class="fas fa-car"></i> تحكم بلوتوث في سيارة DC</h1>
            <p>نظام تحكم كامل مع إطفاء حرائق - مشروع تخرج</p>
        </header>

        <div class="status-bar">
            <div class="status-item disconnected">
                <div class="status-icon">
                    <i class="fas fa-bluetooth"></i>
                </div>
                <div class="status-text">
                    <div class="status-label">الاتصال:</div>
                    <div class="status-value" id="connection-status">غير متصل</div>
                </div>
            </div>
            <div class="status-item no-fire">
                <div class="status-icon">
                    <i class="fas fa-fire-extinguisher"></i>
                </div>
                <div class="status-text">
                    <div class="status-label">حالة الحريق:</div>
                    <div class="status-value" id="fire-status">لا يوجد</div>
                </div>
            </div>
            <div class="status-item">
                <div class="status-icon" style="background: linear-gradient(135deg, var(--secondary), var(--primary));">
                    <i class="fas fa-cogs"></i>
                </div>
                <div class="status-text">
                    <div class="status-label">وضع التشغيل:</div>
                    <div class="status-value" id="operation-mode">يدوي</div>
                </div>
            </div>
            <div class="status-item">
                <div class="status-icon" style="background: linear-gradient(135deg, var(--warning), #ff9800);">
                    <i class="fas fa-battery-three-quarters"></i>
                </div>
                <div class="status-text">
                    <div class="status-label">طاقة البطارية:</div>
                    <div class="status-value" id="battery-level">85%</div>
                </div>
            </div>
        </div>

        <div class="control-section">
            <div class="control-panel">
                <h2 class="section-title"><i class="fas fa-gamepad"></i> تحكم يدوي في السيارة</h2>
                <div class="direction-control">
                    <div class="direction-row">
                        <button class="control-btn" id="forward-btn" data-direction="forward">
                            <i class="fas fa-arrow-up"></i>
                        </button>
                    </div>
                    <div class="direction-row">
                        <button class="control-btn" id="left-btn" data-direction="left">
                            <i class="fas fa-arrow-left"></i>
                        </button>
                        <button class="control-btn center-btn" id="stop-btn" data-direction="stop">
                            <i class="fas fa-stop"></i>
                        </button>
                        <button class="control-btn" id="right-btn" data-direction="right">
                            <i class="fas fa-arrow-right"></i>
                        </button>
                    </div>
                    <div class="direction-row">
                        <button class="control-btn" id="backward-btn" data-direction="backward">
                            <i class="fas fa-arrow-down"></i>
                        </button>
                    </div>
                </div>
                <div class="sensor-data">
                    <div class="sensor-item">
                        <div class="sensor-label">درجة الحرارة</div>
                        <div class="sensor-value" id="temperature-value">25°C</div>
                    </div>
                    <div class="sensor-item">
                        <div class="sensor-label">مستوى الدخان</div>
                        <div class="sensor-value" id="smoke-value">120</div>
                    </div>
                </div>
            </div>

            <div class="control-panel">
                <h2 class="section-title"><i class="fas fa-fire-extinguisher"></i> نظام إطفاء الحرائق</h2>
                <div class="fire-control">
                    <div class="mode-selector">
                        <button class="mode-btn active" id="manual-mode-btn">
                            <i class="fas fa-hand-paper"></i> يدوي
                        </button>
                        <button class="mode-btn" id="auto-mode-btn">
                            <i class="fas fa-robot"></i> تلقائي
                        </button>
                    </div>
                    
                    <div class="manual-controls">
                        <button class="fire-btn" id="activate-sprinkler-btn">
                            <i class="fas fa-fire-extinguisher"></i> تشغيل الرشاش
                        </button>
                        <button class="fire-btn stop" id="stop-sprinkler-btn">
                            <i class="fas fa-stop-circle"></i> إيقاف الرشاش
                        </button>
                    </div>
                    
                    <div class="auto-status" id="auto-status">
                        <i class="fas fa-info-circle"></i> الوضع التلقائي غير نشط. النظام يراقب الحريق تلقائياً.
                    </div>
                </div>
                
                <div class="instructions">
                    <h3><i class="fas fa-info-circle"></i> تعليمات التشغيل:</h3>
                    <ul>
                        <li>اتصل بالسيارة عبر البلوتوث أولاً</li>
                        <li>في الوضع اليدوي: استخدم أزرار التحكم لتحريك السيارة</li>
                        <li>في الوضع التلقائي: تتحرك السيارة وتتجنب العوائق</li>
                        <li>النظام يكتشف الحرائق ويشغل الرشاش تلقائياً</li>
                    </ul>
                </div>
            </div>
        </div>

        <div class="connection-control">
            <h2 class="section-title"><i class="fas fa-bluetooth-b"></i> اتصال البلوتوث</h2>
            <div class="bluetooth-devices" id="bluetooth-devices">
                <div class="device-item" style="text-align: center; color: #bbdefb;">
                    <i class="fas fa-search"></i> اضغط على زر البحث للعثور على الأجهزة
                </div>
            </div>
            <button class="connect-btn" id="scan-btn">
                <i class="fas fa-search"></i> بحث عن أجهزة بلوتوث
            </button>
            <button class="connect-btn disconnect" id="connect-btn" style="display: none;">
                <i class="fas fa-unlink"></i> قطع الاتصال
            </button>
        </div>

        <div class="logs">
            <h2 class="section-title"><i class="fas fa-clipboard-list"></i> سجل الأحداث</h2>
            <div class="logs-content" id="logs-content">
                <div class="log-entry log-info">
                    <span class="log-text">جاهز للاتصال بالسيارة عبر البلوتوث</span>
                    <span class="log-time" id="log-time">10:30:15</span>
                </div>
            </div>
        </div>

        <footer>
            <p>مشروع تخرج - سيارة DC الذكية مع إطفاء حرائق | التحكم عبر البلوتوث</p>
            <p>© 2023 - تم التطوير للعمل على الهواتف الذكية</p>
        </footer>
    </div>

    <script>
        // بلوتوث API للتحكم الحقيقي
        const appState = {
            connected: false,
            fireDetected: false,
            autoMode: false,
            sprinklerActive: false,
            batteryLevel: 85,
            temperature: 25,
            smokeLevel: 120,
            device: null,
            server: null,
            characteristic: null,
            devices: []
        };

        // عناصر DOM
        const connectionStatus = document.getElementById('connection-status');
        const fireStatus = document.getElementById('fire-status');
        const operationMode = document.getElementById('operation-mode');
        const batteryLevel = document.getElementById('battery-level');
        const temperatureValue = document.getElementById('temperature-value');
        const smokeValue = document.getElementById('smoke-value');
        const autoStatus = document.getElementById('auto-status');
        const logsContent = document.getElementById('logs-content');
        const scanBtn = document.getElementById('scan-btn');
        const connectBtn = document.getElementById('connect-btn');
        const bluetoothDevices = document.getElementById('bluetooth-devices');
        
        // أزرار التحكم
        const forwardBtn = document.getElementById('forward-btn');
        const backwardBtn = document.getElementById('backward-btn');
        const leftBtn = document.getElementById('left-btn');
        const rightBtn = document.getElementById('right-btn');
        const stopBtn = document.getElementById('stop-btn');
        
        // أزرار نظام الإطفاء
        const manualModeBtn = document.getElementById('manual-mode-btn');
        const autoModeBtn = document.getElementById('auto-mode-btn');
        const activateSprinklerBtn = document.getElementById('activate-sprinkler-btn');
        const stopSprinklerBtn = document.getElementById('stop-sprinkler-btn');

        // تحديث الوقت في السجلات
        function updateLogTime() {
            const now = new Date();
            return now.toLocaleTimeString('ar-EG', {hour12: false});
        }

        // إضافة سجل جديد
        function addLog(message, type = 'info') {
            const logEntry = document.createElement('div');
            logEntry.className = `log-entry log-${type}`;
            logEntry.innerHTML = `<span class="log-text">${message}</span> <span class="log-time">${updateLogTime()}</span>`;
            
            logsContent.appendChild(logEntry);
            logsContent.scrollTop = logsContent.scrollHeight;
            
            // حفظ فقط آخر 30 سجل
            const logs = logsContent.querySelectorAll('.log-entry');
            if (logs.length > 30) {
                logs[0].remove();
            }
        }

        // تحديث واجهة المستخدم
        function updateUI() {
            // تحديث حالة الاتصال
            connectionStatus.textContent = appState.connected ? 'متصل' : 'غير متصل';
            connectionStatus.parentElement.parentElement.className = 
                `status-item ${appState.connected ? 'connected' : 'disconnected'}`;
            
            // تحديث حالة الحريق
            fireStatus.textContent = appState.fireDetected ? 'حريق!' : 'لا يوجد';
            fireStatus.parentElement.parentElement.className = 
                `status-item ${appState.fireDetected ? 'fire-detected' : 'no-fire'}`;
            
            // تحديث وضع التشغيل
            operationMode.textContent = appState.autoMode ? 'تلقائي' : 'يدوي';
            
            // تحديث مستوى البطارية
            batteryLevel.textContent = `${appState.batteryLevel}%`;
            
            // تحديث قراءات الحساسات
            temperatureValue.textContent = `${appState.temperature}°C`;
            smokeValue.textContent = appState.smokeLevel;
            
            // تحديث حالة الرشاش
            if (appState.sprinklerActive) {
                activateSprinklerBtn.innerHTML = '<i class="fas fa-fire-extinguisher"></i> الرشاش يعمل...';
                activateSprinklerBtn.disabled = true;
                stopSprinklerBtn.disabled = false;
            } else {
                activateSprinklerBtn.innerHTML = '<i class="fas fa-fire-extinguisher"></i> تشغيل الرشاش';
                activateSprinklerBtn.disabled = !appState.connected;
                stopSprinklerBtn.disabled = true;
            }
            
            // تحديث حالة الوضع التلقائي
            if (appState.autoMode) {
                autoModeBtn.classList.add('active');
                manualModeBtn.classList.remove('active');
                
                // تعطيل أزرار التحكم اليدوي
                [forwardBtn, backwardBtn, leftBtn, rightBtn, stopBtn].forEach(btn => {
                    btn.disabled = true;
                });
                
                if (appState.fireDetected) {
                    autoStatus.innerHTML = '<i class="fas fa-exclamation-triangle"></i> تم اكتشاف حريق! النظام يشغل الرشاش تلقائياً.';
                    autoStatus.classList.add('fire-detected');
                } else {
                    autoStatus.innerHTML = '<i class="fas fa-check-circle"></i> الوضع التلقائي نشط. السيارة تتحرك تلقائياً.';
                    autoStatus.classList.remove('fire-detected');
                }
            } else {
                autoModeBtn.classList.remove('active');
                manualModeBtn.classList.add('active');
                
                // تمكين أزرار التحكم اليدوي إذا كان متصلاً
                [forwardBtn, backwardBtn, leftBtn, rightBtn, stopBtn].forEach(btn => {
                    btn.disabled = !appState.connected;
                });
                
                autoStatus.innerHTML = '<i class="fas fa-info-circle"></i> الوضع التلقائي غير نشط. النظام يراقب الحريق تلقائياً.';
                autoStatus.classList.remove('fire-detected');
            }
            
            // تحديث أزرار الاتصال
            if (appState.connected) {
                scanBtn.style.display = 'none';
                connectBtn.style.display = 'block';
            } else {
                scanBtn.style.display = 'block';
                connectBtn.style.display = 'none';
            }
        }

        // إرسال بيانات عبر البلوتوث
        async function sendBluetoothData(command) {
            if (!appState.connected || !appState.characteristic) {
                addLog('غير متصل بالسيارة', 'error');
                return false;
            }
            
            try {
                // تحويل النص إلى مصفوفة بايتات
                const encoder = new TextEncoder();
                const data = encoder.encode(command);
                
                // إرسال البيانات
                await appState.characteristic.writeValue(data);
                addLog(`تم إرسال: ${command}`, 'success');
                return true;
            } catch (error) {
                addLog(`خطأ في الإرسال: ${error.message}`, 'error');
                return false;
            }
        }

        // استقبال بيانات من البلوتوث
        async function setupBluetoothReceiver() {
            if (!appState.characteristic) return;
            
            try {
                // تفعيل الاستقبال
                await appState.characteristic.startNotifications();
                
                appState.characteristic.addEventListener('characteristicvaluechanged', event => {
                    const value = event.target.value;
                    const decoder = new TextDecoder();
                    const receivedData = decoder.decode(value);
                    
                    // معالجة البيانات المستقبلة
                    processReceivedData(receivedData);
                });
                
                addLog('جاهز لاستقبال البيانات من السيارة', 'success');
            } catch (error) {
                addLog(`خطأ في إعداد المستقبل: ${error.message}`, 'error');
            }
        }

        // معالجة البيانات المستقبلة من Arduino
        function processReceivedData(data) {
            console.log('بيانات مستلمة:', data);
            
            // أمثلة على تنسيق البيانات المتوقعة:
            // TEMP:25.5
            // SMOKE:150
            // FIRE:1
            // BATTERY:80
            // MODE:AUTO
            
            const parts = data.trim().split(':');
            if (parts.length !== 2) return;
            
            const [key, value] = parts;
            
            switch(key) {
                case 'TEMP':
                    appState.temperature = parseFloat(value);
                    break;
                case 'SMOKE':
                    appState.smokeLevel = parseInt(value);
                    break;
                case 'FIRE':
                    appState.fireDetected = value === '1';
                    if (appState.fireDetected) {
                        addLog('تم اكتشاف حريق من الحساس', 'error');
                        if (appState.autoMode) {
                            activateSprinkler();
                        }
                    }
                    break;
                case 'BATTERY':
                    appState.batteryLevel = parseInt(value);
                    break;
                case 'MODE':
                    if (value === 'AUTO') {
                        appState.autoMode = true;
                    } else {
                        appState.autoMode = false;
                    }
                    break;
            }
            
            updateUI();
        }

        // البحث عن أجهزة بلوتوث
        async function scanBluetoothDevices() {
            try {
                addLog('جاري البحث عن أجهزة بلوتوث...', 'info');
                
                // طلب الإذن للوصول إلى البلوتوث
                const device = await navigator.bluetooth.requestDevice({
                    filters: [
                        {name: 'DC Car'},
                        {name: 'Arduino'},
                        {name: 'HC-05'},
                        {name: 'HC-06'},
                        {namePrefix: 'CAR'},
                        {namePrefix: 'ARDUINO'}
                    ],
                    optionalServices: ['00001101-0000-1000-8000-00805f9b34fb'] // خدمة تسلسلية قياسية
                });
                
                if (!device) {
                    addLog('لم يتم اختيار جهاز', 'warning');
                    return;
                }
                
                appState.device = device;
                addLog(`تم اختيار الجهاز: ${device.name || 'غير معروف'}`, 'success');
                
                // الاتصال بالجهاز
                await connectToBluetoothDevice(device);
                
            } catch (error) {
                if (error.name === 'NotFoundError') {
                    addLog('لم يتم العثور على أجهزة بلوتوث', 'error');
                } else if (error.name === 'SecurityError') {
                    addLog('خطأ في الأذونات. يرجى منح إذن الوصول إلى البلوتوث', 'error');
                } else if (error.name === 'AbortError') {
                    addLog('تم إلغاء عملية البحث', 'warning');
                } else {
                    addLog(`خطأ في البحث: ${error.message}`, 'error');
                }
            }
        }

        // الاتصال بجهاز بلوتوث
        async function connectToBluetoothDevice(device) {
            try {
                addLog('جاري الاتصال بالجهاز...', 'info');
                
                // إضافة مستمع لفقدان الاتصال
                device.addEventListener('gattserverdisconnected', onBluetoothDisconnected);
                
                // الاتصال بخادم GATT
                const server = await device.gatt.connect();
                appState.server = server;
                
                // الحصول على الخدمة التسلسلية
                const service = await server.getPrimaryService('00001101-0000-1000-8000-00805f9b34fb');
                
                // الحصول على خاصية الكتابة
                const characteristic = await service.getCharacteristic('00001143-0000-1000-8000-00805f9b34fb');
                appState.characteristic = characteristic;
                
                appState.connected = true;
                addLog('تم الاتصال بالسيارة بنجاح!', 'success');
                
                // إعداد استقبال البيانات
                await setupBluetoothReceiver();
                
                updateUI();
                
            } catch (error) {
                addLog(`خطأ في الاتصال: ${error.message}`, 'error');
                appState.connected = false;
                updateUI();
            }
        }

        // قطع الاتصال بالبلوتوث
        async function disconnectBluetooth() {
            if (appState.device && appState.device.gatt.connected) {
                try {
                    appState.device.gatt.disconnect();
                    addLog('تم قطع الاتصال', 'info');
                } catch (error) {
                    console.error('خطأ في قطع الاتصال:', error);
                }
            }
            
            appState.connected = false;
            appState.device = null;
            appState.server = null;
            appState.characteristic = null;
            
            updateUI();
        }

        // عند فقدان الاتصال
        function onBluetoothDisconnected() {
            addLog('فقدان الاتصال بالسيارة', 'error');
            appState.connected = false;
            updateUI();
        }

        // تشغيل الرشاش
        async function activateSprinkler() {
            if (appState.sprinklerActive) return;
            
            appState.sprinklerActive = true;
            addLog('جاري تشغيل الرشاش...', 'warning');
            
            // إرسال أمر إلى Arduino
            const success = await sendBluetoothData('SPRINKLER_ON');
            
            if (success) {
                addLog('تم تشغيل الرشاش', 'success');
            }
            
            updateUI();
        }

        // إيقاف الرشاش
        async function deactivateSprinkler() {
            if (!appState.sprinklerActive) return;
            
            appState.sprinklerActive = false;
            addLog('جاري إيقاف الرشاش...', 'info');
            
            // إرسال أمر إلى Arduino
            const success = await sendBluetoothData('SPRINKLER_OFF');
            
            if (success) {
                addLog('تم إيقاف الرشاش', 'success');
            }
            
            updateUI();
        }

        // محاكاة بيانات الحساسات (للاختبار فقط)
        function simulateSensorData() {
            if (!appState.connected) return;
            
            // تغييرات عشوائية صغيرة في القيم
            const tempChange = (Math.random() - 0.5) * 1.5;
            appState.temperature = Math.max(15, Math.min(40, appState.temperature + tempChange));
            
            const smokeChange = (Math.random() - 0.5) * 15;
            appState.smokeLevel = Math.max(50, Math.min(500, appState.smokeLevel + smokeChange));
            
            // اكتشاف الحريق (لأغراض العرض/الاختبار)
            const newFireDetected = appState.smokeLevel > 300 && appState.temperature > 35;
            
            if (newFireDetected && !appState.fireDetected) {
                appState.fireDetected = true;
                addLog('تم اكتشاف حريق (محاكاة)', 'error');
                
                // إذا كان في الوضع التلقائي، قم بتشغيل الرشاش
                if (appState.autoMode) {
                    setTimeout(() => activateSprinkler(), 500);
                }
            } else if (!newFireDetected && appState.fireDetected) {
                appState.fireDetected = false;
                addLog('تم إخماد الحريق (محاكاة)', 'success');
                
                // إذا كان الرشاش يعمل، قم بإيقافه
                if (appState.sprinklerActive) {
                    setTimeout(() => deactivateSprinkler(), 500);
                }
            }
            
            // استهلاك البطارية
            if (appState.sprinklerActive) {
                appState.batteryLevel = Math.max(0, appState.batteryLevel - 0.3);
            } else {
                appState.batteryLevel = Math.max(0, appState.batteryLevel - 0.08);
            }
            
            updateUI();
        }

        // معالجة أحداث الأزرار
        function setupEventListeners() {
            // زر البحث عن أجهزة بلوتوث
            scanBtn.addEventListener('click', scanBluetoothDevices);
            
            // زر قطع الاتصال
            connectBtn.addEventListener('click', disconnectBluetooth);
            
            // أزرار التحكم في الاتجاه
            forwardBtn.addEventListener('click', async () => {
                if (!appState.connected) return;
                addLog('توجيه السيارة إلى الأمام', 'info');
                await sendBluetoothData('FORWARD');
            });
            
            backwardBtn.addEventListener('click', async () => {
                if (!appState.connected) return;
                addLog('توجيه السيارة إلى الخلف', 'info');
                await sendBluetoothData('BACKWARD');
            });
            
            leftBtn.addEventListener('click', async () => {
                if (!appState.connected) return;
                addLog('توجيه السيارة إلى اليسار', 'info');
                await sendBluetoothData('LEFT');
            });
            
            rightBtn.addEventListener('click', async () => {
                if (!appState.connected) return;
                addLog('توجيه السيارة إلى اليمين', 'info');
                await sendBluetoothData('RIGHT');
            });
            
            stopBtn.addEventListener('click', async () => {
                if (!appState.connected) return;
                addLog('إيقاف السيارة', 'info');
                await sendBluetoothData('STOP');
            });
            
            // أزرار نظام الإطفاء
            manualModeBtn.addEventListener('click', async () => {
                if (!appState.connected) return;
                appState.autoMode = false;
                addLog('تم تفعيل الوضع اليدوي', 'info');
                await sendBluetoothData('MODE_MANUAL');
                updateUI();
            });
            
            autoModeBtn.addEventListener('click', async () => {
                if (!appState.connected) return;
                appState.autoMode = true;
                addLog('تم تفعيل الوضع التلقائي', 'info');
                await sendBluetoothData('MODE_AUTO');
                updateUI();
            });
            
            activateSprinklerBtn.addEventListener('click', async () => {
                if (!appState.connected) return;
                await activateSprinkler();
            });
            
            stopSprinklerBtn.addEventListener('click', async () => {
                if (!appState.connected) return;
                await deactivateSprinkler();
            });
            
            // اختصارات لوحة المفاتيح (للتجربة على الحاسوب)
            document.addEventListener('keydown', async (e) => {
                if (!appState.connected || appState.autoMode) return;
                
                switch(e.key.toLowerCase()) {
                    case 'arrowup':
                    case 'w':
                        forwardBtn.click();
                        forwardBtn.style.transform = 'scale(0.92)';
                        break;
                    case 'arrowdown':
                    case 's':
                        backwardBtn.click();
                        backwardBtn.style.transform = 'scale(0.92)';
                        break;
                    case 'arrowleft':
                    case 'a':
                        leftBtn.click();
                        leftBtn.style.transform = 'scale(0.92)';
                        break;
                    case 'arrowright':
                    case 'd':
                        rightBtn.click();
                        rightBtn.style.transform = 'scale(0.92)';
                        break;
                    case ' ':
                        stopBtn.click();
                        stopBtn.style.transform = 'scale(0.92)';
                        break;
                }
            });
            
            document.addEventListener('keyup', () => {
                [forwardBtn, backwardBtn, leftBtn, rightBtn, stopBtn].forEach(btn => {
                    btn.style.transform = '';
                });
            });
            
            // منع التمرير عند لمس أزرار التحكم
            const controlButtons = document.querySelectorAll('.control-btn, .mode-btn, .fire-btn');
            controlButtons.forEach(btn => {
                btn.addEventListener('touchstart', (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                }, {passive: false});
                
                btn.addEventListener('touchend', (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                }, {passive: false});
            });
        }

        // تهيئة التطبيق
        function init() {
            addLog('لوحة التحكم جاهزة', 'success');
            addLog('اضغط على "بحث عن أجهزة بلوتوث" للاتصال', 'info');
            
            setupEventListeners();
            updateUI();
            
            // محاكاة بيانات الحساسات كل 2 ثانية
            setInterval(simulateSensorData, 2000);
            
            // إظهار إشعار دعم البلوتوث
            if (!navigator.bluetooth) {
                addLog('المتصفح لا يدعم Web Bluetooth API', 'error');
                addLog('يرجى استخدام Chrome على Android أو Edge على Windows 10+', 'warning');
            }
        }

        // بدء التطبيق
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
